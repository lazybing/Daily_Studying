## 摘要

码率控制是 CBR 编码中的一项重要技术。AVC 标准包含几种帧间和帧内预测模式。现有的 AVC 软件很难采用现有的码率控制技术，因为基于先决量化参数的率失真优化(RDO)决定每个宏块的最优预测。针对 AVC 标准，本文提出了一种基于自适应量化参数的宏块级码率控制算法。实验结果表明，本位提出的码率控制算法能够准确地实现目标码率。尽管视频序列的目标质量 PSNR 略有下降，编码效率与固定量化参数视频编码相当或优于固定量化参数视频编码。

## 引言

码率控制在 CBR 视频编码中起着非常重要的作用，尽管它不是所有视频编码标准的规范工具。然而，如果没有码率控制，许多视频方案在许多应用中都是无用的。因为当压缩刘传送信道保持恒定带宽时，客户端缓冲区可能经常发生上溢或下溢。因此，每个视频编码标准都有自己的码率控制技术，例如 MPEG-2 的 TM5 和 H.263 的 TMN8。

AVC标准是由 ISO 和 ITU-T 联合视频团队(JVT)联合开发的（在H.26x 系列标准中也称为 MPEG-4 第 10 部分和 H.264），它通过利用各种时间和空间预测技术，已经显著地优于先前的视频编码标准。最优预测由 RDO 基于先决量化参数确定。但是， AVC 标准很难采用现有的速率控制技术。

率失真理论是视频编码的基础理论。率和失真之间的关系是一个不等式函数，如图 1 所示。在给定码率约束下，RDO 使解码失真最小。拉格朗日方法能有效地解决这一问题，已在 H.263+ 的 TMN10 中得到应用。在 AVC 中，运动补偿和帧内预测采用拉格朗日方法进行模式选择。也就是说，在给定的码率约束条件下，该算法可以使失真最小化，并找到块的最优运动矢量和编码方式。

然而，在 AVC 中使用拉格朗日方法使得码率控制成为一项困难的任务，因为码率和失真的计算涉及到量化参数。对于不同的量化参数，可以选择不同的运动矢量和编码模式。因此，块的速率和失真与码率控制决定的量化参数相关联。换句话说，在调整量化参数之后，码率控制方案将影响块的运动矢量和模式选择。

由于编码效率高，AVC 是一种很有钱途的视频编码标准。然而，不同于现有的视频编码标准，AVC 标准中的码率控制由于涉及量化参数，很难应用于宏块级的码率控制和 RDO。综合考虑码率控制和 RDO 的基础上，提出了一种适用于 AVC 标准的宏块级码率控制算法。我们的重点是通过使用宏块层来解决上述问题，进而提高具有高运动或场景变化的帧的质量。

本文结构如下：第 2 节回顾了现有的速率控制算法；第 3 节提出了解决现有速率控制问题的策略；第 4 节给出了实验结果；最后，第 5 节对本文进行了总结，并对今后的工作提出了建议。

## 相关工作

## 提出算法

在预测性差的图像序列中，场景变化、缩放和快速运动可能由于与前一图片的相关性小而发生图像质量下降。本文提出了一种简单的方法，通过改变前一帧和当前帧之间的相关性来提高 H.264 编解码器的性能。

本文提出了五个步骤：1. 缓冲区占用初始化；2. 确定目标缓冲区占用率；3. 目标比特流的计算；4. 确定当前帧的宏块的量化参数；5. 率失真优化。步骤 2 和步骤 3 与 [14] 相同。

### 步骤1：初始化

为了估计当前帧的目标比特，采用了基于线性跟踪理论的流模型。为简单起见，假设使用一组图片(GOP)，并且首先将视频序列编码为 I 帧，然后编码为 P 帧。为了说明速率控制模型，N 表示 GOP 中的总帧数,n<sub>j</sub>(j = 1, 2, ..., N)表示 j<sup>th</sup> 帧，并且 B<sub>c</sub>(n<sub>j</sub>)表示编码帧后虚拟缓冲区的占用。流模型如式（1）所示。

B<sub>C</sub>(n<sub>j+1</sub>) = min{max{0, B<sub>C</sub>(n<sub>j</sub>) + A(n<sub>j</sub>) - u(n<sub>j</sub>) / F<sub>r</sub>}, B<sub>S</sub>}  
B<sub>c</sub>(n<sub>1</sub>) = B<sub>S</sub>/8

其中**A(n<sub>j</sub>)** 是j<sup>th</sup> 帧生成的比特数，u(n<sub>j</sub>) 是可用信道带宽，F<sub>r</sub> 是预定义的帧率，B<sub>S</sub>是缓冲区大小。

### 步骤2：目标缓冲区占用率的确定

因为该算法中第一个 P 帧的量化参数是在 GOP 层给出的，因此目标缓冲级别的初始值如等式 Tbl(n<sub>2</sub>) = B<sub>c</sub>(n<sub>2</sub>) 所示。  

然后利用该函数预测 GOP 中其他 P 帧的目标缓冲级别。Tbl(n<sub>j+1</sub>) = Tbl(n<sub>j</sub>) - ((Tbl(n<sub>j-1</sub>) - Bs/8) / Np - 1); 其中 Np 是 GOP 中 P 帧的总数量。

### 步骤3：目标比特率的计算

### 步骤4：量化参数的确定

本文在 AVC 上实现了速率优化和速率控制的联合方案。由于当前 AVC 使用拉格朗日方法选择编码模式，因此首先使用预测的量化参数进行模式选择，并且使用宏块的活动度量。然而，根据活动度量和虚拟缓冲区占用率调整量化参数。然后利用最终的量化参数对编码模式进行细化。

### 步骤5：率失真优化

然后，通过使用步骤 4，量化参数用于对当前帧中的每个 MB 执行 RDO。AVC 中的宏块的编码模式可以是下面集合中的 {SKIP, INTRA4x4, INTRA16x16, INTER16x16,INTER16x8, INTER8x16, INTER8x8, INTER4x8, INTER8x4, INTER4x4}。拉格朗日法被用来求解帧间编码块的最优运动矢量和任何块的最优编码模式。它在解决运动矢量的最优比特分配和编码器中的残差编码方面具有很高的性能。对于帧间的块，首先进行速率约束的运动估计，通过极小化找到最优运动矢量。
