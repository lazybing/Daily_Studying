# 摘要

对于 AVC 中的码率控制来说，最重要的一点是准确地获得当前帧的统计信息。为实现这一点，提出了一种新的自适应编码特性预测方案，利用时空相关性来提升R-D 建模的精度。利用所提出的预测方案，我们提出了一种新的速率函数和线性失真模型，然后导出了最优比特分配问题的一个简单闭式解(与 TMN-8 相似的方式)。大量实验表明，对于带宽要求较低的各种测试序列，该方案比现行标准化码率控制方案 JVT-G012 的每帧增益提高了 0.92 dB。

# 引言

码率控制的目标是调节编码比特流以满足某些给定条件，例如防止缓冲区上溢或下溢、可变或低带宽限制。

码率控制作为影响编码性能的关键问题之一，尽管目前大多数混合视频编码标准(如 MPEG-2、H.264、MPEG-4、H264/AVC)都没有对其进行规范，它仍然受到了广泛的研究关注。

## A. 码率控制方案简介

一般来说，一个典型的码率控制方案包括两个基本操作：1) 比特分配 2) 比特分配实现，即比特率控制。最优码率控制可以通过最优比特分配和精确的码率控制共同实现。最佳的比特分配任务是在图像块之间有效地分配比特预算，从而获得最佳的视频质量。最佳比特分配问题可以用如下公式表述：`min D, subject to R < Rc` 其中 D 表示整体失真，Rc 表示比特预算，R 表示用于编码帧的比特数。

为了实现目标比特率，速率控制方案适当的选择量化参数。为了保证精度，根据量化参数对编码比特率进行精确的建模或估计（即速率量化函数R-D）是非常重要的。速率量化函数（R-D）与失真量化函数（D-Q）一起，描述了视频编码的率失真行为（R-D），这是最佳比特分配的关键问题。

在过去的研究中，已经报道了许多 R-Q 和 D-Q 函数，并且同时提出了各种比特分配方案。其中一些已经被采用到各种标准兼容的视频编码器中，例如TM-5、TMN-8 和 VM-8。然而，在这些速率控制方案中，只有 TMN-8 在宏块到宏块的基础上实现了最佳比特分配。

## B:H.264/AVC 中的速率控制

H.264/AVC 是最近批准的一种视频编码标准，它以增加复杂度为代价，在编码性能上比以前的编码标准有了显著的改进。将拉格朗日编码器控制方法并入 H.264/AVC 编码器以获得高编码性能。然而，拉格朗日编码控制方法要求在帧内、帧间预测之前对量化参数进行评估，这倒是一个进退两难的局面，因为直到帧内、帧间预测结束时，速率控制方案无法获得量化参数计算所必需的统计信息。这样的困境阻碍了速率控制方案直接访问预先的统计信息。

在 JVT-D030 中，Ma 提出了一种双通道(2-pass)方案来避免上述困境，即在每个通道（each pass）中使用 TM-5 类似方法。如果第一遍未能获得适当的量化参数，则第二遍就会进行改进，因此会增加计算复杂度。此外，JVT-D030 使用了极其简化的 R-D 函数，因此无法实现精确和鲁棒的速率控制。

在 JVT-G012 中，Li 提出的一种 One-pass 方案，利用时空相关性来避免这种困境，其中线性 MAD 模型用于预测编码复杂度，传统的 MPEG-4 Q2 函数用于计算量化参数。然而，时空相关性没有得到充分的利用，因此导致对编码特性的预测比较弱。

JVT-D030 和 JVT-G012 都未能实现最佳比特分配。在 JVT-G012 中，总目标比特的分配正好与每个图像块的编码复杂度成比例。

## C. 提出的H.264/AVC 的最优比特分配和比特率控制方案

我们的目标是计算上可行的解决方案，它是为 H.264/AVC 标准在宏块为基础上的最佳比特分配方案。为了实现这一目标，我们应该准确地建模 R-D 行为，因此，首先要绕过拉格朗日编码控制方法引入的障碍。作为一种解决方案，提出了一种新的自适应预测方案来精确估计视频内容的编码特性。其中当选择数据点进行回归分析过程时，以及当使用所得到的的 R-D 模型预测编码特性时，均采用时空连续性准则。

在此基础上，提出了一种线性失真模型和一种改进的 Q2 率模型，并用该方法提高了预测精度。在此基础上，利用拉格朗日优化方法，得到了最优比特分配问题的封闭解。

我们在 JM-10 中实现了新的速率控制方案，并将其性能与 JVT-G012 的速率控制方案进行了比较。实现结果表明，该方案能更准确有效地进行比特分配。与 JVT-G012 速率控制方案相比，该方案的视频质量提高了 0.92 dB/帧。

## D. 本论文组织

论文的其余部分组织如下。首先，在第二节中，提出了一种新的编码特性预测方案。然后，我们在第三节推到了R-D 模型。在第四节中，我们推导了最优比特分配的一个闭式解。然后在第五节提出了一种率失真优化的码率控制方案。在第六节中，我们进行了大量的实验来评估所提出的速率控制方案的性能。本文的结论是第七节。

# 全局编码特征预测

一般说来，视频内容的变化通常可以被视为视频对象相对于成像平面的运动的结果。现实世界中视频对象的运动，本质上具有很高的时空相关性、依懒性，这也在视频内容中得到了体现。因此，我们可以在连续图片和空间上相邻的块之间找到极大的相似性，这些相似性在混合编码中几乎被帧内、帧间预测消除了。然而，在残差编码中，仍然存在显著的相关性。在一些研究中，时空相关性被用来加速运动估计以预测编码复杂度。在一些与速率控制相关的工作中，时空相关性提高了关于相邻块共享相似 R-D 曲线的假设。

然而，如下文所述，在预测编码特性(例如开销比特率、编码复杂度和R-D行为等)时，先前与码率控制相关的工作犹豫对相关性的不良利用，使得预测误差较大，速率控制方案的性能在很大程度上依赖于 R-D 模型。为了改进 R-D 模型，我们提出了一种启发式自适应编码特征预测方案，它包括两种方法。

# 率失真建模

如上所述，H.264/AVC的R-D建模问题由于其复杂性的增加而变得复杂。对于先前的编码标准，研究主要集中在R-Q和D-Q函数上，而对于H.264/AVC，需要额外注意如何获得当前帧的统计信息。着眼于R-D建模问题，我们将其分解为四个重要部分，包括开销比特率预测、编码复杂度预测、R-Q建模和D-Q建模，这将分别在下文中详细描述。

## A. 开销比特率预测

由源编码器生成的整体比特流主要包括用于纹理编码的比特加上用于差分编码开销信息的比特，例如宏块模式、运动矢量和量化参数。现有的大多数码率控制方案将开销比特视为整个比特流中的一个恒定分量，并在编码完一个宏块（或一帧）后用平均开销比特率对其进行更新。

传统方法不再适合H.264/AVC，因为编码结构变得复杂，导致编码开销信息所需的比特数可能发生剧烈变化。不幸的是，JVT-G012速率控制方案遵循这种方式，并且容易受到较大预测误差的影响。

在这项工作中，利用时空相关性来提高开销比特率预测的准确性。如前所述，在空间和时间相邻宏块的运动矢量之间存在广泛的相关性。此外，还可以观察到，在空间和时间上相邻的宏块之间优选类似的模式选择。所有这些观察强烈表明，在空间和时间上相邻的宏块之间，开销比特率可能很接近。进行实验1来证明这一点，典型的实验结果如图1所示。实验通过搜索当前宏块和前一个P帧中所有宏块之间的开销比特数的最小差值来完成，距离当前宏块的同一位置不超过搜索半径。

因此，我们可以使用前一个P帧的开销比特率来预测当前P帧的开销比特率。如图1所示，搜索半径为1的预测比搜索半径为0的预测更好。但是，如果搜索半径不是0，我们将混淆多个宏块之间的选择。因此，为了简单起见，我们建议通过在前一个P帧中的同位位置直接预测尚未编码的宏块的开销比特数。其规定如下：`H(i) = H(i)_prev`  其中`H(i)`表示当前的 P 帧中第 i 个宏块的整体比特，`H(i)_prev`表示先前的 P 帧中第 i 个宏块的整体比特。

为了验证所提出的方法，已经进行了大量的实验，典型结果如图2所示。结果表明，新公式比JVT-G012更准确、更稳健。


